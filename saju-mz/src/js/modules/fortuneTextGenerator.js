/**
 * fortuneTextGenerator.js - 상세 사주 분석 텍스트 생성
 * 11개 섹션, 각 300-500+ 단어, 총 ~4,500단어 (30분 분량)
 * 일간별 기본 텍스트 + 십신 보정 + 오행 균형 + 계절/합충 상호작용
 */

export class FortuneTextGenerator {
  /**
   * 전체 분석 텍스트 생성
   * @param {Object} sajuResult - SajuCalculator 결과
   * @param {Object} sipsinResult - SipsinAnalyzer 결과
   * @param {Object} daewoonResult - DaewoonCalculator 결과
   * @returns {Object} 11개 섹션 텍스트
   */
  generate(sajuResult, sipsinResult, daewoonResult) {
    const ctx = this.buildContext(sajuResult, sipsinResult, daewoonResult);

    return {
      basicAnalysis: this.generateBasicAnalysis(ctx),
      elementAnalysis: this.generateElementAnalysis(ctx),
      sipsinAnalysis: this.generateSipsinAnalysis(ctx),
      daewoonAnalysis: this.generateDaewoonAnalysis(ctx),
      personality: this.generatePersonality(ctx),
      romance: this.generateRomance(ctx),
      wealth: this.generateWealth(ctx),
      career: this.generateCareer(ctx),
      health: this.generateHealth(ctx),
      yearFortune: this.generateYearFortune(ctx),
      advice: this.generateAdvice(ctx)
    };
  }

  /**
   * 분석에 필요한 컨텍스트 구성
   */
  buildContext(sajuResult, sipsinResult, daewoonResult) {
    const dm = sajuResult.dayMaster;
    const dmElement = sajuResult.dayMasterElement;
    const dmYinYang = sajuResult.dayMasterYinYang;
    const gender = sajuResult.gender;
    const genderKo = gender === 'male' ? '남성' : '여성';
    const pillars = sajuResult.pillars;
    const elements = sajuResult.elements;
    const sipsin = sipsinResult;
    const daewoon = daewoonResult;
    const dominant = sipsinResult.dominant;

    // 계절 판별 (월지 기준)
    const monthBranch = pillars.month.branch;
    const season = this.getSeason(monthBranch);

    // 일간 강약 판단
    const strength = this.judgeDayMasterStrength(sajuResult, sipsinResult);

    return {
      dm, dmElement, dmYinYang, gender, genderKo,
      pillars, elements, sipsin, daewoon, dominant,
      season, strength, name: sajuResult.name
    };
  }

  getSeason(monthBranch) {
    const seasonMap = {
      '인': '봄', '묘': '봄', '진': '봄',
      '사': '여름', '오': '여름', '미': '여름',
      '신': '가을', '유': '가을', '술': '가을',
      '해': '겨울', '자': '겨울', '축': '겨울'
    };
    return seasonMap[monthBranch] || '봄';
  }

  judgeDayMasterStrength(sajuResult, sipsinResult) {
    const dominant = sipsinResult.dominant;
    const bigyeop = dominant.groups['비겁'] || 0;
    const inseong = dominant.groups['인성'] || 0;
    const helpCount = bigyeop + inseong;

    // 득령(월지가 일간을 도와주는지) 체크
    const monthBranchEl = sajuResult.pillars.month.branchElement;
    const dmEl = sajuResult.dayMasterElement;
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmEl);
    const mbIdx = cycle.indexOf(monthBranchEl);
    const deukryeong = (dmEl === monthBranchEl) || ((mbIdx + 1) % 5 === dmIdx);

    if (helpCount >= 4 || (helpCount >= 3 && deukryeong)) {
      return { level: 'strong', description: '신강(身强)', detail: '일간의 기운이 강하여 자아가 확고합니다.' };
    } else if (helpCount <= 1 && !deukryeong) {
      return { level: 'weak', description: '신약(身弱)', detail: '일간의 기운이 약하여 도움이 필요합니다.' };
    }
    return { level: 'balanced', description: '중화(中和)', detail: '일간의 기운이 적절히 균형잡혀 있습니다.' };
  }

  // =====================================================
  // 1. 사주팔자 기본 분석
  // =====================================================
  generateBasicAnalysis(ctx) {
    const { dm, dmElement, dmYinYang, pillars, name, genderKo, strength, season } = ctx;

    const elementNames = { '목': '나무', '화': '불', '토': '흙', '금': '쇠', '수': '물' };
    const dmName = elementNames[dmElement];
    const yearP = pillars.year.display;
    const monthP = pillars.month.display;
    const dayP = pillars.day.display;
    const hourP = pillars.hour ? pillars.hour.display : '(시간 미상)';

    let text = `<h4>사주 명식 해석</h4>`;
    text += `<p><strong>${name}</strong>님(${genderKo}), 반가워요! 지금부터 ${name}님만의 사주를 같이 풀어볼게요 ✨</p>`;
    text += `<p>사주팔자는 태어난 해(년주), 달(월주), 날(일주), 시간(시주) 이렇게 네 기둥으로 이루어져 있어요. 각 기둥마다 천간과 지지 두 글자씩, 총 여덟 글자(八字)가 ${name}님의 인생 이야기를 담고 있답니다!</p>`;

    text += `<p><strong>년주:</strong> ${yearP} | <strong>월주:</strong> ${monthP} | <strong>일주:</strong> ${dayP} | <strong>시주:</strong> ${hourP}</p>`;

    text += `<p>사주에서 제일 중요한 건 바로 <strong>일간(日干)</strong>이에요! 쉽게 말하면 "사주 속 나 자신"이라고 보면 돼요. ${name}님의 일간은 <strong>${dm}(${dmYinYang}${dmElement})</strong>이에요. ${dmYinYang}의 ${dmName} 기운을 타고나셨는데, 이게 바로 ${name}님의 성격과 기질을 만들어주는 핵심이랍니다!</p>`;

    text += `<p>${ctx.sipsin.profile.dayMasterDescription}</p>`;

    text += `<p>년주 <strong>${yearP}</strong>은 조상궁이자 어린 시절의 환경을 보여줘요. ${pillars.year.element} 기운의 천간과 ${pillars.year.branchElement} 기운의 지지가 조합되어 있어요.</p>`;

    text += `<p>월주 <strong>${monthP}</strong>은 부모궁이면서 청년기의 운을 나타내요. 사회에서 어떤 모습인지, 어떤 직업이 잘 맞는지도 여기서 알 수 있거든요! ${season}에 태어나셨으니 ${this.getSeasonalInfluence(dmElement, season)} 계절의 영향을 받아요.</p>`;

    text += `<p>일주 <strong>${dayP}</strong>는 ${name}님 본인과 배우자궁을 나타내요. 일간 ${dm}이 나 자신이라면, 일지 ${pillars.day.branch}(${pillars.day.branchElement})은 미래 배우자의 성향과 가정환경을 보여준답니다!</p>`;

    if (pillars.hour) {
      text += `<p>시주 <strong>${hourP}</strong>는 자녀궁이자 말년의 운을 보여줘요. ${pillars.hour.element} 기운의 천간과 ${pillars.hour.branchElement} 기운의 지지로 이루어져 있어요.</p>`;
    }

    text += `<p>사주 전체의 강약을 보면, ${name}님은 <strong>${strength.description}</strong>한 사주예요. ${strength.detail}</p>`;

    return text;
  }

  getSeasonalInfluence(element, season) {
    const influences = {
      '목': { '봄': '목이 왕성한', '여름': '화기를 생하여 설기되는', '가을': '금에 의해 극을 받는', '겨울': '수의 생을 받는' },
      '화': { '봄': '목의 생을 받는', '여름': '화가 왕성한', '가을': '토를 생하여 설기되는', '겨울': '수에 의해 극을 받는' },
      '토': { '봄': '목에 의해 극을 받는', '여름': '화의 생을 받는', '가을': '금을 생하여 설기되는', '겨울': '수를 극하지만 힘이 빠지는' },
      '금': { '봄': '화의 극을 받기 쉬운', '여름': '화에 의해 극을 받는', '가을': '금이 왕성한', '겨울': '수를 생하여 설기되는' },
      '수': { '봄': '목을 생하여 설기되는', '여름': '화에 의해 극을 받는', '가을': '금의 생을 받는', '겨울': '수가 왕성한' }
    };
    return influences[element]?.[season] || '';
  }

  // =====================================================
  // 2. 오행 분석
  // =====================================================
  generateElementAnalysis(ctx) {
    const { elements, dmElement, dm, name, strength } = ctx;
    const { count, strongest, weakest, missing } = elements;

    const elementInfo = {
      '목': { name: '목(木, 나무)', organ: '간/담', emotion: '분노', color: '청색/녹색', direction: '동쪽', season: '봄' },
      '화': { name: '화(火, 불)', organ: '심장/소장', emotion: '기쁨', color: '적색', direction: '남쪽', season: '여름' },
      '토': { name: '토(土, 흙)', organ: '비/위', emotion: '사려', color: '황색', direction: '중앙', season: '환절기' },
      '금': { name: '금(金, 쇠)', organ: '폐/대장', emotion: '슬픔', color: '백색', direction: '서쪽', season: '가을' },
      '수': { name: '수(水, 물)', organ: '신장/방광', emotion: '공포', color: '흑색', direction: '북쪽', season: '겨울' }
    };

    let text = `<h4>오행의 균형과 상호작용</h4>`;
    text += `<p>오행(五行)은 목(木)·화(火)·토(土)·금(金)·수(水) 다섯 가지 기운이에요. 세상 모든 것이 이 다섯 기운으로 돌아가거든요! ${name}님의 사주에 어떤 기운이 얼마나 있는지 같이 살펴볼게요 😊</p>`;

    text += `<p><strong>오행 분포:</strong> 목(${count['목']}) · 화(${count['화']}) · 토(${count['토']}) · 금(${count['금']}) · 수(${count['수']})</p>`;

    text += `<p>가장 강한 오행은 <strong>${elementInfo[strongest.element].name}</strong>(${strongest.count}개)이에요! `;

    // 강한 오행 해석
    const strongEl = elementInfo[strongest.element];
    text += `${strongest.element} 기운이 강하다는 건 ${strongEl.season}의 기운, ${strongEl.direction}의 방향, ${strongEl.emotion}의 감정과 깊이 연결되어 있다는 뜻이에요. 장부로는 ${strongEl.organ}과 관련되니까, 이 부분이 활발하거나 과하게 작용할 수 있어요.</p>`;

    // 약한 오행 해석
    if (missing.length > 0) {
      text += `<p>사주에서 <strong>${missing.map(m => elementInfo[m].name).join(', ')}</strong>이(가) 좀 부족해요. `;
      missing.forEach(m => {
        const info = elementInfo[m];
        text += `${m} 기운이 부족하면 ${info.organ} 관련 건강에 신경 써야 하고, ${info.emotion}의 감정을 다루기가 어려울 수 있어요. ${info.color} 계열의 색상이나 ${info.direction} 방향으로 보완하면 도움이 돼요! `;
      });
      text += `</p>`;
    } else {
      text += `<p>다행히 사주에 오행이 모두 갖춰져 있어서 큰 결함은 없어요! 다만 가장 약한 <strong>${elementInfo[weakest.element].name}</strong>(${weakest.count}개)을 보완해주면 더 좋답니다 👍</p>`;
    }

    // 상생상극 흐름
    text += `<h4>오행의 상생상극</h4>`;
    text += `<p>오행은 서로 도와주기도(생, 生) 하고 견제하기도(극, 克) 해요. 나무는 불을 키워주고, 불은 흙을 만들고, 흙에서 쇠가 나오고, 쇠에서 물이 생기고, 물은 다시 나무를 키워주는 순환 관계예요!</p>`;

    text += `<p>${name}님의 일간 ${dm}은 ${dmElement} 기운이에요. `;
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const generates = cycle[(dmIdx + 1) % 5];
    const controls = cycle[(dmIdx + 2) % 5];
    const generatedBy = cycle[(dmIdx + 4) % 5];
    const controlledBy = cycle[(dmIdx + 3) % 5];

    text += `${dmElement}은 ${generates}을(를) 도와주고, ${controls}을(를) 견제하며, ${generatedBy}한테 도움을 받고, ${controlledBy}한테 견제를 받아요. `;

    if (count[generatedBy] >= 2) {
      text += `사주에 ${generatedBy} 기운이 충분해서 ${name}님을 잘 도와주고 있어요! 학문적 도움이나 윗사람의 지원이 있다는 뜻이에요. `;
    }
    if (count[controlledBy] >= 2) {
      text += `${controlledBy} 기운이 강해서 가끔 압박을 느낄 수 있지만, 이게 오히려 성장의 원동력이 되기도 해요! `;
    }

    text += `</p>`;

    // 신강/신약에 따른 용신 제안
    text += `<h4>용신(用神) 방향</h4>`;
    if (strength.level === 'strong') {
      text += `<p>${name}님은 신강한 사주라서 기운이 넘치는 편이에요! 그래서 에너지를 적절히 쓸 수 있는 오행(식상·재성)이 용신이 될 수 있어요. ${generates}(식상)이나 ${controls}(재성) 기운을 활용하면 삶의 밸런스를 찾을 수 있답니다. 활동적이고 생산적인 일에 에너지를 쏟아보세요!</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>${name}님은 신약한 사주라서 도움을 주는 기운이 중요해요. 일간을 도와주는 오행(비겁·인성)이 용신이 될 수 있어요. ${dmElement}(비겁)이나 ${generatedBy}(인성) 기운을 보충해주면 좋아요. 같은 기운의 사람이나 환경에서 힘을 얻을 수 있으니 참고하세요!</p>`;
    } else {
      text += `<p>${name}님은 중화된 사주라서 특정 오행에 크게 치우치지 않아요. 상황에 따라 필요한 오행을 보충하며 유연하게 대처하면 돼요! 전체적인 밸런스가 잘 잡혀 있어서 안정적인 삶의 기본 틀을 갖추고 있는 거예요 👏</p>`;
    }

    return text;
  }

  // =====================================================
  // 3. 십신 분석
  // =====================================================
  generateSipsinAnalysis(ctx) {
    const { sipsin, dm, name, genderKo } = ctx;
    const { sipsinCount, dominant } = sipsin;

    let text = `<h4>십신(十神)으로 보는 인생의 구조</h4>`;
    text += `<p>십신은 "나"를 중심으로 주변 기운들과의 관계를 열 가지로 나눈 거예요. 이걸 통해 ${name}님의 성격, 인간관계, 재물, 직업, 건강 등 삶 전체의 흐름을 읽을 수 있답니다!</p>`;

    // 각 십신 그룹별 해석
    const groups = dominant.groups;
    const sorted = dominant.sorted;

    text += `<p><strong>십신 분포:</strong> `;
    sorted.forEach(([group, count]) => {
      text += `${group}(${count}) `;
    });
    text += `</p>`;

    // 비겁 (비견 + 겁재)
    text += `<h4>비겁(比劫) - 나와 같은 기운</h4>`;
    if (groups['비겁'] >= 3) {
      text += `<p>비겁이 강한 ${name}님은 자아가 뚜렷하고 독립심이 강해요! 주관이 확실해서 남한테 쉽게 흔들리지 않고, 스스로 결정하고 행동하는 걸 좋아하는 타입이에요. 다만 고집 세다는 말을 들을 수도 있고, 재물이 새어나가기 쉬우니 동업이나 보증은 조심하세요! 승부욕이 있어서 목표를 향해 화끈하게 밀어붙이는 매력이 있어요 🔥</p>`;
    } else if (groups['비겁'] >= 1) {
      text += `<p>비겁이 적당히 있어서 자아 정체성이 안정적이에요. 독립심과 협조성이 밸런스가 좋고, 필요할 때 주변 도움도 잘 받으면서 자기 주관도 유지할 수 있어요. 형제자매나 동료와의 관계도 원만한 편이에요!</p>`;
    } else {
      text += `<p>비겁이 좀 부족한 편이에요. 자기 주장보다 다른 사람 의견을 따르는 경향이 있고, 혼자 일을 추진하는 게 어려울 수 있어요. 스스로 힘을 키워나가는 게 중요하답니다! 💪</p>`;
    }

    // 식상 (식신 + 상관)
    text += `<h4>식상(食傷) - 표현과 창의의 기운</h4>`;
    if (groups['식상'] >= 3) {
      text += `<p>식상이 강한 ${name}님은 표현력과 창의력이 정말 뛰어나요! 말재주도 좋고 예술적 감각도 있어서, 자유로운 사고를 하는 타입이에요. 기존 틀에 얽매이기 싫어하고 늘 새로운 걸 찾아다니죠! 다만 너무 자유분방하면 직장에서 마찰이 생길 수 있으니 적절한 밸런스가 필요해요. ${genderKo === '여성' ? '참고로 여성에게 식상은 자녀를 의미하기도 해서, 자녀와의 인연이 깊어요!' : '남성에게 식상은 활동력과 재능을 나타내서, 기술이나 예술 분야에서 빛날 수 있어요!'}</p>`;
    } else if (groups['식상'] >= 1) {
      text += `<p>식상이 적당히 있어서 자기 표현력이 좋은 편이에요. 필요할 때 생각을 잘 전달하고, 적절한 창의성도 발휘해요. 음식복도 있고 건강 관리에도 관심이 많은 편이에요 😋</p>`;
    } else {
      text += `<p>식상이 좀 부족한 편이에요. 자기 표현이 서투르거나 내성적인 면이 있을 수 있어요. 하고 싶은 말을 참을 때가 많고, 스트레스를 안에 쌓아두는 경향이 있거든요. 취미활동이나 창작으로 표현의 통로를 만들어보세요!</p>`;
    }

    // 재성 (편재 + 정재)
    text += `<h4>재성(財星) - 재물과 현실의 기운</h4>`;
    if (groups['재성'] >= 3) {
      text += `<p>재성이 강한 ${name}님은 현실 감각이 탁월하고 돈에 대한 감이 좋아요! 돈 버는 능력이 있고 경제활동에도 적극적이에요. 다만 재성이 너무 많으면 체력이 빠질 수 있으니 건강 관리가 중요해요. ${genderKo === '남성' ? '남성에게 재성은 배우자를 의미하기도 해서 이성에게 인기가 많을 수 있어요!' : '여성에게 재성은 경제적 자립을 나타내서 재정적으로 독립적인 삶을 살 수 있어요!'} 물질적 풍요도 좋지만 건강과 마음의 여유도 같이 챙기세요 💰</p>`;
    } else if (groups['재성'] >= 1) {
      text += `<p>재성이 적당히 있어서 재물 운이 안정적이에요. 무리하지 않으면 꾸준한 수입을 유지할 수 있고, 현실적인 판단력도 좋아요. 절약과 투자의 밸런스를 잘 잡는 편이에요!</p>`;
    } else {
      text += `<p>재성이 좀 부족한 편이에요. 물질보다 정신적 가치를 중시하는 타입이에요. 돈에 관심이 적거나 재물 관리가 서투를 수 있으니, 경제적 계획을 세우는 습관을 들여보세요!</p>`;
    }

    // 관성 (편관 + 정관)
    text += `<h4>관성(官星) - 직업과 명예의 기운</h4>`;
    if (groups['관성'] >= 3) {
      text += `<p>관성이 강한 ${name}님은 책임감이 강하고 규율을 중시하는 타입이에요. 조직에서 인정받기 쉽고, 공직이나 대기업 같은 안정된 곳에서 능력을 발휘해요! 다만 관성이 너무 많으면 스트레스를 많이 받을 수 있어요. ${genderKo === '여성' ? '여성에게 관성은 배우자를 의미하기도 해서 배우자의 영향이 큰 편이에요.' : '남성에게 관성은 직장이나 사회적 지위를 나타내서 승진이나 성취에 관심이 많아요.'} 너무 자신을 몰아붙이지 말고 적절히 쉬어가세요!</p>`;
    } else if (groups['관성'] >= 1) {
      text += `<p>관성이 적당히 있어서 사회적 질서와 규범을 잘 따르는 편이에요. 직장생활 적응력도 좋고, 책임감 있는 모습으로 신뢰를 얻어요. 안정적인 삶을 지향하는 타입이에요!</p>`;
    } else {
      text += `<p>관성이 좀 부족한 편이에요. 조직의 규율이나 틀에 맞추는 게 불편할 수 있어요. 프리랜서나 자영업, 자유로운 환경이 더 잘 맞을 수 있답니다!</p>`;
    }

    // 인성 (편인 + 정인)
    text += `<h4>인성(印星) - 학문과 지혜의 기운</h4>`;
    if (groups['인성'] >= 3) {
      text += `<p>인성이 강한 ${name}님은 학문적이고 사색적인 타입이에요! 배우는 걸 좋아하고 지적 호기심이 넘쳐요. 어머니나 윗사람의 도움을 많이 받고, 자격증이나 학위 등에서 좋은 성과를 거두기 쉬워요. 다만 인성이 너무 많으면 생각만 많고 행동이 느려질 수 있으니, 배운 건 바로 실천으로 옮겨보세요! 📚</p>`;
    } else if (groups['인성'] >= 1) {
      text += `<p>인성이 적당히 있어서 학습 능력이 좋은 편이에요. 필요한 지식을 잘 익히고 실생활에도 잘 적용해요. 부모님이나 선생님 등 윗사람과의 관계도 원만해요!</p>`;
    } else {
      text += `<p>인성이 좀 부족한 편이에요. 이론보다 실전 경험으로 배우는 타입일 수 있어요. 윗사람의 도움이 적을 수 있지만, 그만큼 스스로 개척하는 힘이 강해요! 자격증이나 전문 교육으로 보완하면 좋아요 ✨</p>`;
    }

    return text;
  }

  // =====================================================
  // 4. 대운 흐름
  // =====================================================
  generateDaewoonAnalysis(ctx) {
    const { daewoon, name, dm, dmElement } = ctx;
    const { isForward, startAge, daewoons, currentDaewoon, currentAge } = daewoon;

    let text = `<h4>대운(大運)의 흐름</h4>`;
    text += `<p>대운은 10년 단위로 바뀌는 인생의 큰 흐름이에요! ${name}님은 <strong>${isForward ? '순행' : '역행'}</strong> 대운으로, ${startAge}세부터 대운이 시작돼요.</p>`;

    text += `<p>현재 나이(한국식) <strong>${currentAge}세</strong>로, 지금 <strong>${currentDaewoon.display} 대운</strong>(${currentDaewoon.ageRange})을 지나고 있어요!</p>`;

    // 대운 리스트
    text += `<h4>대운 일람</h4>`;
    text += `<p>`;
    daewoons.forEach(dw => {
      const isCurrent = dw === currentDaewoon;
      if (isCurrent) {
        text += `<strong>→ ${dw.display}(${dw.ageRange}) [현재]</strong> · `;
      } else {
        text += `${dw.display}(${dw.ageRange}) · `;
      }
    });
    text = text.slice(0, -3); // 마지막 · 제거
    text += `</p>`;

    // 현재 대운 상세 해석
    text += `<h4>현재 대운 해석: ${currentDaewoon.display}운</h4>`;
    const cdElement = currentDaewoon.element;
    const cdBranchEl = currentDaewoon.branchElement;

    text += `<p>지금 지나고 있는 ${currentDaewoon.display} 대운의 천간은 ${currentDaewoon.stem}(${cdElement})이고, 지지는 ${currentDaewoon.branch}(${cdBranchEl})이에요. `;

    // 대운과 일간 관계
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const cdIdx = cycle.indexOf(cdElement);

    if (dmElement === cdElement) {
      text += `대운 기운이 일간과 같아서 자아가 강해지고 자신감이 넘치는 시기예요! 주체적으로 일을 추진할 수 있지만, 고집이 세질 수 있으니 주의하세요 😊</p>`;
    } else if ((dmIdx + 4) % 5 === cdIdx) {
      text += `대운이 일간을 도와줘서 도움과 지원이 들어오는 좋은 시기예요! 학업, 자격증, 승진 등에 유리하고 귀인의 도움도 받을 수 있어요 🍀</p>`;
    } else if ((dmIdx + 1) % 5 === cdIdx) {
      text += `일간이 대운을 도와주는 형태라 에너지 소모가 많은 시기예요. 바빠질 수 있으니 건강 관리에 신경 쓰세요!</p>`;
    } else if ((dmIdx + 2) % 5 === cdIdx) {
      text += `재물이나 성과를 적극적으로 추구하게 되는 시기예요! 사업이나 투자에 관심이 높아지고, 재물을 얻을 기회가 있어요 💰</p>`;
    } else {
      text += `외부의 압력이나 변화가 있는 시기예요. 직장에서의 변동이나 도전이 있을 수 있지만, 이걸 통해 한 단계 성장할 수 있답니다!</p>`;
    }

    // 과거~미래 대운 흐름 요약
    text += `<h4>대운 흐름 요약</h4>`;
    text += `<p>`;
    daewoons.slice(0, 6).forEach(dw => {
      const el = dw.element;
      let quality;
      if (el === dmElement || cycle[(dmIdx + 4) % 5] === el) {
        quality = '안정과 성장';
      } else if (cycle[(dmIdx + 2) % 5] === el) {
        quality = '재물과 성취';
      } else if (cycle[(dmIdx + 3) % 5] === el) {
        quality = '도전과 변화';
      } else {
        quality = '활동과 표현';
      }
      text += `<strong>${dw.display}(${dw.ageRange})</strong>: ${quality}의 시기. `;
    });
    text += `</p>`;

    return text;
  }

  // =====================================================
  // 5. 성격 분석
  // =====================================================
  generatePersonality(ctx) {
    const { dm, dmElement, dmYinYang, name, sipsin, strength, season, genderKo } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님은 이런 사람이에요!</h4>`;

    // 일간 기반 성격
    const personalities = {
      '갑': `<p>${name}님은 <strong>갑목(甲木)</strong> 일간! 큰 소나무처럼 곧고 당당한 기질을 타고났어요. 리더십이 뛰어나고 정의감이 강해서 불의를 보면 참지 못하는 타입이에요! 새로운 분야를 개척하고 앞장서는 선구자적 성향이 있고, 사람들을 이끄는 데도 능숙해요 🌲</p><p>다만 갑목 특유의 강직함이 때로 융통성 부족으로 보일 수 있어요. 한 번 정한 건 잘 안 바꾸고, 자기 방식을 고수하거든요. 주변 조언에 귀 기울이는 연습이 필요해요! 봉사정신이 있고 약자를 돕는 걸 좋아하는, 큰 뜻을 품은 사람이에요.</p>`,
      '을': `<p>${name}님은 <strong>을목(乙木)</strong> 일간! 풀이나 꽃처럼 유연하고 아름다운 기질을 가졌어요. 적응력이 대단하고, 부드럽게 사람들 마음을 사로잡는 능력이 있어요. 예술적 감각이 뛰어나고 아름다움을 추구하는 타입! 🌸</p><p>겉으로는 유순해 보이지만 내면에는 엄청 강한 생명력이 있어요. 바위틈에서도 자라나는 잡초처럼 어떤 상황에서도 살아남는 끈기가 있거든요! 처세술도 좋아서 대인관계가 원만하고 외교적 수완이 뛰어나요.</p>`,
      '병': `<p>${name}님은 <strong>병화(丙火)</strong> 일간! 태양처럼 밝고 뜨거운 기질을 타고났어요 ☀️ 열정 넘치고 에너지가 대단하며, 주변에 긍정적인 영향을 주는 타입이에요. 카리스마가 있어서 자연스럽게 주목받고, 활달하고 사교적이에요!</p><p>태양처럼 숨기는 게 없고 솔직해요. 분위기 메이커 역할을 잘 하고, 사람들과 함께하는 걸 좋아해요. 다만 감정 기복이 있을 수 있고, 너무 급하게 달려가는 성향은 조절이 필요해요!</p>`,
      '정': `<p>${name}님은 <strong>정화(丁火)</strong> 일간! 촛불이나 별빛처럼 은은하고 따뜻한 기질이에요 🕯️ 내면에 깊은 열정이 있으면서도 겉으로는 차분하고 조용한 타입이에요. 섬세한 감수성과 날카로운 관찰력을 가졌어요!</p><p>어둠 속에서 빛을 비추는 촛불처럼, 주변에 따뜻한 위로와 지혜를 전해주는 사람이에요. 학구열이 높고 연구를 좋아하며, 예술이나 문화 분야에서 뛰어난 재능을 보여요. 한 분야를 깊이 파고드는 장인 기질이 있답니다!</p>`,
      '무': `<p>${name}님은 <strong>무토(戊土)</strong> 일간! 큰 산처럼 듬직하고 안정적인 기질을 가졌어요 ⛰️ 신뢰감이 있고 포용력이 커서 주변에서 많이 의지하는 타입이에요. 갈등을 중재하는 능력도 뛰어나요!</p><p>변함없는 태도로 사람들에게 안정감을 주고, 어떤 상황에서도 흔들리지 않는 강인함이 있어요. 약속을 소중히 여기고 인연을 중시해요. 다만 변화를 꺼리거나 새로운 시도를 주저할 수 있으니, 가끔은 도전도 필요해요!</p>`,
      '기': `<p>${name}님은 <strong>기토(己土)</strong> 일간! 비옥한 논밭처럼 모든 걸 품어주는 따뜻한 기질이에요 🌾 세심하고 실용적이며, 주변을 꼼꼼하게 챙기는 어머니 같은 따스함이 있어요. 현실 감각도 탁월하고요!</p><p>겸손하고 착실한 성격으로 주변의 신뢰를 얻고, 꾸준히 노력해서 성과를 만들어내요. 사소한 것도 놓치지 않는 꼼꼼함이 장점이에요! 다만 걱정이 좀 많고 소심한 면이 있을 수 있으니, 자신감을 키워보세요!</p>`,
      '경': `<p>${name}님은 <strong>경금(庚金)</strong> 일간! 바위나 무쇠처럼 강하고 결단력 있는 기질이에요 ⚔️ 의리를 중시하고 한 번 마음먹으면 끝까지 밀어붙이는 추진력이 대단해요! 불의를 참지 못하는 정의파!</p><p>거침없이 행동하는 스타일로, 결정이 빠르고 실행력이 뛰어나요. 원칙과 약속을 꼭 지키는 사람이에요. 다만 너무 직설적이거나 강하게 보일 수 있으니, 상대방 감정도 좀 배려해주면 더 좋아요!</p>`,
      '신': `<p>${name}님은 <strong>신금(辛金)</strong> 일간! 보석처럼 세련되고 예리한 기질을 가졌어요 💎 미적 감각이 뛰어나고 완벽주의 성향이 있으며, 자존심이 높은 타입이에요. 작은 것에서도 아름다움을 찾아내는 안목이 있어요!</p><p>섬세하고 날카로운 감각의 소유자로, 품격 있는 삶을 추구해요. 분석력이 뛰어나서 분석적인 일에 강해요. 다만 예민해서 상처를 잘 받을 수 있고, 완벽주의가 스트레스가 될 수 있으니 좀 내려놓는 연습도 해보세요!</p>`,
      '임': `<p>${name}님은 <strong>임수(壬水)</strong> 일간! 큰 바다나 강물처럼 넓고 깊은 기질을 가졌어요 🌊 포용력이 크고 지혜로우며, 큰 뜻을 품은 사람이에요. 유연하면서도 강해서 어떤 장애물도 돌아서 나아갈 수 있어요!</p><p>호기심이 많고 다양한 분야에 관심을 가지며, 새로운 걸 탐구하는 걸 좋아해요. 사교성도 좋고 인맥도 넓어요! 다만 방향성을 잃으면 물처럼 여기저기 흘러다닐 수 있으니, 명확한 목표 설정이 중요해요!</p>`,
      '계': `<p>${name}님은 <strong>계수(癸水)</strong> 일간! 이슬이나 빗물처럼 맑고 순수한 기질을 가졌어요 💧 직관력이 뛰어나고 감수성이 풍부하며, 내면이 깊은 사람이에요. 조용히 관찰하고 분석하는 능력이 대단해요!</p><p>겸손하고 수용적인 태도로 주변에서 호감을 얻고, 세밀한 부분까지 놓치지 않는 꼼꼼함이 있어요. 학문이나 연구, 예술에서 재능을 보이며, 철학적인 관심도 높은 편이에요. 다만 좀 소극적으로 보일 수 있으니 결단력을 키워보세요!</p>`
    };

    text += personalities[dm] || '';

    // 십신 보정
    const strongest = dominant.strongest;
    if (strongest[1] > 0) {
      text += `<h4>십신으로 본 성격 보정</h4>`;
      const sipsinPersonality = {
        '비겁': `<p>비겁이 강하여 독립심과 주체성이 더욱 강화됩니다. 자기 길을 가는 성향이 강하며, 경쟁적인 환경에서 빛을 발합니다. 형제자매나 동료와의 관계가 성격 형성에 큰 영향을 미쳤을 수 있습니다.</p>`,
        '식상': `<p>식상이 강하여 창의적이고 표현력이 풍부한 성격이 더해집니다. 예술적 재능이 있으며, 자유로운 사고방식으로 독창적인 아이디어를 잘 냅니다. 맛있는 것을 좋아하고 삶을 즐기는 성향이 있습니다.</p>`,
        '재성': `<p>재성이 강하여 현실 감각이 뛰어나고 실리적인 성격이 더해집니다. 경제 관념이 확실하며 돈을 다루는 감각이 좋습니다. 부지런하고 활동적이며 사회생활에 적극적입니다.</p>`,
        '관성': `<p>관성이 강하여 책임감과 도덕심이 더해집니다. 규율을 중시하고 사회적 체면을 중요하게 여기며, 자기 절제력이 강합니다. 직장에서 인정받기 쉽지만 스트레스 관리에 유의해야 합니다.</p>`,
        '인성': `<p>인성이 강하여 학구적이고 사색적인 성격이 더해집니다. 배우는 것을 좋아하며 지식에 대한 욕구가 강합니다. 어머니 또는 스승의 영향을 많이 받았으며, 정신적 가치를 중시합니다.</p>`
      };
      text += sipsinPersonality[strongest[0]] || '';
    }

    // 계절 보정
    text += `<h4>태어난 계절의 영향</h4>`;
    const seasonPersonality = {
      '봄': `<p>${season}에 태어난 ${name}님은 생기와 활력이 넘칩니다. 새싹이 돋아나는 봄의 기운처럼 성장 지향적이고 희망적입니다. 새로운 시작을 잘하며, 시행착오를 두려워하지 않는 도전적 성향이 있습니다.</p>`,
      '여름': `<p>${season}에 태어난 ${name}님은 열정과 에너지가 넘칩니다. 뜨거운 여름의 기운처럼 활발하고 적극적이며, 밝은 성격으로 주변을 환하게 합니다. 감정이 풍부하고 표현력이 뛰어납니다.</p>`,
      '가을': `<p>${season}에 태어난 ${name}님은 성숙함과 결실의 기운을 가졌습니다. 가을의 풍성함처럼 내실을 중시하며, 깊이 있는 사고력을 지녔습니다. 판단력이 명확하고 결단력이 있습니다.</p>`,
      '겨울': `<p>${season}에 태어난 ${name}님은 깊은 내면의 힘을 가졌습니다. 겨울의 고요함처럼 침착하고 인내심이 강하며, 어려움 속에서도 흔들리지 않는 강인함이 있습니다. 사색적이고 지혜로운 성향입니다.</p>`
    };
    text += seasonPersonality[season] || '';

    return text;
  }

  // =====================================================
  // 6. 연애운
  // =====================================================
  generateRomance(ctx) {
    const { dm, dmElement, name, genderKo, gender, sipsin, pillars, strength } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 연애 스타일 & 배우자운 💕</h4>`;

    // 일간별 연애 스타일
    const romanceStyles = {
      '갑': `<p>${name}님은 연애에서도 당당하고 솔직한 타입이에요! 진심을 숨기지 않고, 리드하는 연애를 좋아해요. 자존심이 있어서 먼저 다가가긴 좀 어려워하지만, 한 번 마음을 열면 한결같이 사랑하는 스타일이에요. 사랑하는 사람을 꼭 지켜야 한다는 보호본능이 강해요!</p>`,
      '을': `<p>${name}님은 연애에서 유연하고 매력 넘치는 스타일이에요! 상대 마음을 잘 읽고 분위기를 맞추는 능력이 탁월해요. 로맨틱한 감성이 풍부하고 데이트를 즐기며, 세심한 배려가 장점이에요. 다만 모두에게 잘해줘서 오해를 살 수도 있으니 주의!</p>`,
      '병': `<p>${name}님은 연애에서 열정 그 자체예요! 한눈에 반하는 사랑을 경험하기 쉽고, 사랑에 빠지면 세상이 반짝거려요 ✨ 아낌없이 주는 타입이고 함께하는 시간을 소중히 여겨요. 다만 식을 때도 빠를 수 있으니 꾸준한 관심이 필요해요!</p>`,
      '정': `<p>${name}님은 연애에서 깊고 진지한 타입이에요. 가볍게 만나는 것보다 진짜 마음이 통하는 사람을 원해요. 은은한 매력으로 서서히 상대 마음을 사로잡는 스타일! 다만 속마음을 잘 안 드러내서 오해를 살 수 있으니, 표현을 좀 더 해보세요!</p>`,
      '무': `<p>${name}님은 연애에서 든든하고 안정적인 타입이에요. 파트너에게 안정감을 주고, 한번 시작한 관계는 끝까지 지키려 해요. 화려한 연애보다 편안한 관계가 좋고, 행동으로 사랑을 표현해요. 다만 로맨틱한 말도 가끔은 필요하답니다!</p>`,
      '기': `<p>${name}님은 연애에서 세심하고 배려가 넘치는 스타일이에요! 상대의 작은 변화도 놓치지 않고 챙겨주며, 따뜻한 사랑을 해요. 가정적이고 안정적인 관계를 원하는 타입! 다만 너무 걱정하면 상대가 답답해할 수 있으니 적당한 거리감도 필요해요!</p>`,
      '경': `<p>${name}님은 연애 직진형이에요! 💘 맘에 드는 사람이 생기면 과감하게 다가가고, 숨김없이 진심을 전해요. 의리 있는 사랑을 하며 배신은 절대 용납 안 해요. 강한 모습과 달리 사랑하는 사람 앞에서는 약해지는 갭이 매력 포인트! 다만 질투는 조절해야 해요!</p>`,
      '신': `<p>${name}님은 연애에서 기준이 확실한 타입이에요. 아무에게나 마음을 열지 않고, 외모와 내면 둘 다 보는 안목이 있어요. 품격 있는 연애를 추구하고, 세련된 데이트를 즐겨요. 다만 기대가 너무 높으면 지칠 수 있으니, 완벽한 사람은 없다는 것도 기억하세요!</p>`,
      '임': `<p>${name}님은 연애에서 자유로운 영혼이에요! 다양한 사람을 만나보는 걸 즐기고, 매력적이고 사교적이라 인기가 많아요. 구속 싫어하고 자유를 중시하지만, 진짜 사랑을 만나면 깊이 빠져들어요. 진정한 인연을 만나면 책임감 있게 사랑하는 게 중요해요!</p>`,
      '계': `<p>${name}님은 연애에서 순수하고 감성적인 타입이에요. 마음이 통하는 소울메이트를 찾는 스타일이에요! 감수성이 풍부해서 상대 감정에 공감하는 능력이 탁월해요. 다만 이상이 좀 높아서 현실과의 갭이 있을 수 있으니, 현실적인 시각도 가져보세요!</p>`
    };

    text += romanceStyles[dm] || '';

    // 배우자궁 분석 (일지)
    text += `<h4>배우자궁으로 본 인연</h4>`;
    const dayBranch = pillars.day.branch;
    const dayBranchEl = pillars.day.branchElement;

    text += `<p>일지(배우자궁)에 <strong>${dayBranch}(${dayBranchEl})</strong>이(가) 있어요! `;

    const spouseTraits = {
      '자': '영리하고 재치 있는 배우자를 만날 가능성이 높습니다. 밤의 기운을 가진 자수(子水)는 지적이고 감성적인 파트너를 의미합니다.',
      '축': '성실하고 끈기 있는 배우자를 만날 가능성이 높습니다. 겨울의 마지막 기운인 축토(丑土)는 믿음직하고 근면한 파트너를 의미합니다.',
      '인': '활동적이고 도전적인 배우자를 만날 가능성이 높습니다. 봄의 시작인 인목(寅木)은 진취적이고 에너지 넘치는 파트너를 의미합니다.',
      '묘': '우아하고 세련된 배우자를 만날 가능성이 높습니다. 봄의 꽃인 묘목(卯木)은 예술적이고 감각적인 파트너를 의미합니다.',
      '진': '포용력 있고 든든한 배우자를 만날 가능성이 높습니다. 봄에서 여름으로 가는 진토(辰土)는 변화에 강하고 적응력 있는 파트너를 의미합니다.',
      '사': '똑똑하고 세련된 배우자를 만날 가능성이 높습니다. 여름의 시작인 사화(巳火)는 지적이고 활발한 파트너를 의미합니다.',
      '오': '열정적이고 밝은 배우자를 만날 가능성이 높습니다. 한여름의 오화(午火)는 에너지 넘치고 사교적인 파트너를 의미합니다.',
      '미': '다정하고 세심한 배우자를 만날 가능성이 높습니다. 여름의 끝인 미토(未土)는 따뜻하고 배려심 깊은 파트너를 의미합니다.',
      '신': '능력 있고 결단력 있는 배우자를 만날 가능성이 높습니다. 가을의 시작인 신금(申金)은 실행력과 추진력이 강한 파트너를 의미합니다.',
      '유': '세련되고 예리한 배우자를 만날 가능성이 높습니다. 가을의 유금(酉金)은 미적 감각이 뛰어나고 완벽주의적인 파트너를 의미합니다.',
      '술': '의리 있고 충직한 배우자를 만날 가능성이 높습니다. 가을의 끝인 술토(戌土)는 신뢰할 수 있고 보호적인 파트너를 의미합니다.',
      '해': '지혜롭고 포용력 있는 배우자를 만날 가능성이 높습니다. 겨울의 시작인 해수(亥水)는 깊이 있고 넓은 시야의 파트너를 의미합니다.'
    };

    text += `${spouseTraits[dayBranch] || ''}</p>`;

    // 십신으로 본 연애 패턴
    text += `<h4>십신으로 본 연애 패턴</h4>`;
    if (gender === 'male') {
      const jaesung = dominant.groups['재성'] || 0;
      if (jaesung >= 3) {
        text += `<p>재성이 많아서 이성에 대한 관심이 높고 인연도 풍부해요! 여러 만남이 있을 수 있지만, 진짜 사랑 하나에 집중하는 게 행복의 비결이에요. 경제적으로도 파트너한테 잘해줄 능력이 있어요 💝</p>`;
      } else if (jaesung === 0) {
        text += `<p>재성이 부족해서 이성 만남이 좀 늦거나 인연이 쉽게 안 올 수 있어요. 하지만 대운에서 재성이 들어오는 시기에 좋은 만남이 찾아올 수 있으니 조급해하지 마세요! 나 자신을 발전시키는 게 좋은 인연을 만드는 최고의 방법이에요 ✨</p>`;
      } else {
        text += `<p>재성이 적당히 있어서 이성과의 관계가 자연스럽게 흘러가요. 적절한 시기에 좋은 인연을 만날 수 있고, 안정적인 연애와 결혼 생활이 기대돼요!</p>`;
      }
    } else {
      const gwansung = dominant.groups['관성'] || 0;
      if (gwansung >= 3) {
        text += `<p>관성이 많아서 이성에게 인기가 많고 인연이 풍부해요! 여러 선택지 중에서 현명하게 판단하는 게 중요하고, 자기만의 기준을 확고히 세워야 해요. 능력 있는 파트너를 만날 가능성이 높아요 💝</p>`;
      } else if (gwansung === 0) {
        text += `<p>관성이 부족해서 배우자 인연이 좀 늦거나, 독립적인 삶을 선호할 수 있어요. 대운에서 관성이 들어오는 시기에 좋은 인연이 올 수 있으니 걱정 마세요! 자기 가치를 아는 게 중요해요 ✨</p>`;
      } else {
        text += `<p>관성이 적당히 있어서 이성 관계가 안정적이에요. 좋은 시기에 좋은 인연을 만나 행복한 관계를 만들어갈 수 있어요. 서로 존중하는 멋진 파트너십이 기대돼요!</p>`;
      }
    }

    return text;
  }

  // =====================================================
  // 7. 재물운
  // =====================================================
  generateWealth(ctx) {
    const { dm, dmElement, name, sipsin, strength, season, daewoon } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 재물운 💰</h4>`;

    // 일간별 재물 성향
    const wealthStyles = {
      '갑': `<p>갑목 일간의 ${name}님은 큰 나무가 많은 열매를 맺듯이 재물을 모을 수 있는 기본적인 역량이 있습니다. 새로운 사업을 시작하거나 개척하는 분야에서 재물을 얻기 쉽습니다. 정직하고 바른 방법으로 재물을 추구하며, 의리를 중시하여 사업 파트너들의 신뢰를 얻을 수 있습니다.</p>`,
      '을': `<p>을목 일간의 ${name}님은 유연한 처세로 다양한 경로에서 재물을 만들어낼 수 있습니다. 사교성을 활용한 네트워크 비즈니스나, 미적 감각을 살린 분야에서 수익을 올릴 수 있습니다. 부드러운 접근으로 거래처를 확보하는 능력이 뛰어납니다.</p>`,
      '병': `<p>병화 일간의 ${name}님은 밝은 에너지로 재물을 끌어당기는 힘이 있습니다. 대중을 상대하는 사업이나 인기를 기반으로 한 활동에서 큰 수익을 올릴 수 있습니다. 투자에도 과감하지만, 충동적 소비를 조심해야 합니다.</p>`,
      '정': `<p>정화 일간의 ${name}님은 지적 능력을 활용하여 재물을 만드는 타입입니다. 전문 지식이나 기술을 통한 수입이 기대되며, 특허나 저작권 등 지식재산으로 수익을 올릴 수 있습니다. 투기보다는 안정적인 투자가 적합합니다.</p>`,
      '무': `<p>무토 일간의 ${name}님은 부동산이나 토지 관련 재물 운이 있습니다. 안정적인 자산을 차근차근 쌓아가는 스타일이며, 장기 투자에 적합합니다. 사람들의 신뢰를 바탕으로 큰 거래를 성사시킬 수 있는 능력이 있습니다.</p>`,
      '기': `<p>기토 일간의 ${name}님은 꾸준한 노력으로 재물을 모으는 타입입니다. 알뜰하고 실용적인 소비 습관이 있으며, 작은 돈도 소중히 여깁니다. 부동산이나 실물 자산에 대한 감각이 있으며, 생활 밀착형 사업에서 수익을 올릴 수 있습니다.</p>`,
      '경': `<p>경금 일간의 ${name}님은 강한 추진력으로 재물을 만들어내는 타입입니다. 결단력 있는 투자와 과감한 사업 추진으로 큰 수익을 올릴 수 있습니다. 금융이나 기술 분야에서 재물 운이 좋으며, 원칙을 지키면서도 승부를 볼 줄 아는 재테크 능력이 있습니다.</p>`,
      '신': `<p>신금 일간의 ${name}님은 세밀한 분석으로 재물을 다루는 타입입니다. 가치 있는 것을 알아보는 안목이 있어 보석, 예술품, 고급 브랜드 관련 사업에서 수익을 올릴 수 있습니다. 품격 있는 소비를 하되, 실속도 챙기는 지혜가 필요합니다.</p>`,
      '임': `<p>임수 일간의 ${name}님은 유동적인 재물 운을 가졌습니다. 큰 물이 흐르듯 재물이 크게 들어오기도 하지만 나가기도 합니다. 무역, 유통, IT 등 유동적인 분야에서 큰 수익을 올릴 수 있습니다. 재물 관리에 체계를 세우는 것이 중요합니다.</p>`,
      '계': `<p>계수 일간의 ${name}님은 지혜를 활용한 재물 운이 있습니다. 정보력과 분석력을 바탕으로 투자 수익을 올릴 수 있으며, 교육이나 연구 분야에서의 수입도 기대됩니다. 큰 모험보다는 안정적인 방법으로 재물을 관리하는 것이 좋습니다.</p>`
    };

    text += wealthStyles[dm] || '';

    // 신강/신약에 따른 재물 운
    text += `<h4>사주 강약으로 본 재물 흐름</h4>`;
    if (strength.level === 'strong') {
      text += `<p>신강한 사주라서 재물을 감당할 수 있는 힘이 있어요! 적극적으로 재물을 추구해도 괜찮고, 사업이나 투자에서 과감한 시도가 좋은 결과를 가져올 수 있어요. 다만 욕심이 지나치면 탈이 날 수 있으니 적절한 선에서 만족하는 지혜가 필요해요!</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>신약한 사주라서 큰 재물을 한꺼번에 감당하기엔 좀 부담스러울 수 있어요. 큰 투자나 무리한 확장보다는 안정적인 수입원을 유지하면서 차근차근 모아가는 게 좋아요! 동업보다는 개인 사업, 투기보다는 저축이 적합해요. 건강을 잘 챙겨서 꾸준히 경제활동 하는 게 재물 운의 핵심이에요!</p>`;
    } else {
      text += `<p>중화된 사주라서 재물 운이 고르게 분포되어 있어요. 극단적인 대박이나 쪽박보다는 꾸준한 성장이 기대돼요! 안정 속에서 기회를 노리는 전략이 효과적이고, 분산 투자가 잘 맞아요 📈</p>`;
    }

    // 재성 분석
    const jaesung = dominant.groups['재성'] || 0;
    text += `<h4>재성으로 본 재물의 크기</h4>`;
    if (jaesung >= 3) {
      text += `<p>사주에 재성이 풍부해서 재물과의 인연이 깊어요! 다양한 경로로 수입이 들어오고, 돈을 다루는 감각이 타고난 편이에요. 다만 재성이 너무 많으면 체력이 빠질 수 있으니, 건강도 함께 챙기세요!</p>`;
    } else if (jaesung === 0) {
      text += `<p>사주에 재성이 없어서 재물과의 직접적 인연이 약할 수 있어요. 하지만 대운이나 세운에서 재성이 들어올 때 큰 기회가 찾아올 수 있어요! 평소에 기술이나 전문성을 쌓아두면 그때 빛을 발한답니다 ✨</p>`;
    } else {
      text += `<p>사주에 재성이 적당히 있어서 재물 운이 안정적이에요. 무리하지 않으면 꾸준히 재물을 쌓아갈 수 있고, 중년 이후에는 더 안정적인 재정 상태를 기대할 수 있어요!</p>`;
    }

    return text;
  }

  // =====================================================
  // 8. 직업운
  // =====================================================
  generateCareer(ctx) {
    const { dm, dmElement, name, sipsin, strength, genderKo } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님에게 딱 맞는 직업은? 💼</h4>`;

    // 일간별 적성
    const careerMap = {
      '갑': `<p>갑목 일간의 ${name}님은 리더십을 발휘할 수 있는 분야가 적합합니다. 경영, 정치, 교육, 법조계, 의료 등 사람들을 이끌고 가르치는 분야에서 두각을 나타냅니다. 창업에도 적합하며, 특히 새로운 분야를 개척하는 벤처나 스타트업에서 강점을 보입니다. 임업, 건설, 교육 분야와도 인연이 있습니다.</p>`,
      '을': `<p>을목 일간의 ${name}님은 사교성과 섬세함을 살릴 수 있는 분야가 적합합니다. 디자인, 패션, 미용, 꽃집, 인테리어 등 아름다움과 관련된 분야에서 재능을 발휘합니다. 외교, 상담, 서비스 분야에서도 좋은 성과를 낼 수 있습니다. 유연한 적응력으로 다양한 환경에서 성공할 수 있습니다.</p>`,
      '병': `<p>병화 일간의 ${name}님은 대중 앞에서 빛나는 분야가 적합합니다. 방송, 연예, 마케팅, 영업, 강연 등 사람들과 교류하는 분야에서 두각을 나타냅니다. 에너지 분야, 전기전자, 조명 관련 사업과도 인연이 있습니다. 열정을 쏟을 수 있는 일에서 최고의 성과를 냅니다.</p>`,
      '정': `<p>정화 일간의 ${name}님은 지적 분야에서 재능을 발휘합니다. 연구, 교수, 작가, 프로그래머, 분석가 등 깊이 있는 사고를 요하는 분야가 적합합니다. 문화예술, 종교, 철학 분야에서도 인연이 있습니다. 집중력을 요하는 전문직에서 좋은 성과를 냅니다.</p>`,
      '무': `<p>무토 일간의 ${name}님은 안정적이고 신뢰가 중요한 분야가 적합합니다. 부동산, 건축, 금융, 공무원, 농업 등 안정적인 기반을 다루는 분야에서 능력을 발휘합니다. 중재나 컨설팅 분야에서도 좋은 성과를 낼 수 있으며, 장기적인 관점에서 사업을 운영하는 데 적합합니다.</p>`,
      '기': `<p>기토 일간의 ${name}님은 세심함과 실용성을 살릴 수 있는 분야가 적합합니다. 식품, 농업, 의료, 보육, 서비스 분야에서 재능을 발휘합니다. 회계, 경리, 사무 관리 등 꼼꼼함이 필요한 일에도 적합합니다. 사람을 돌보는 일에서 보람과 성취를 느낍니다.</p>`,
      '경': `<p>경금 일간의 ${name}님은 강한 추진력을 살릴 수 있는 분야가 적합합니다. 군인, 경찰, 법조인, 외과의, 엔지니어 등 결단력과 실행력이 필요한 분야에서 두각을 나타냅니다. 금속, 기계, 자동차, IT 분야와도 인연이 있습니다. 경쟁이 치열한 환경에서 더 빛을 발합니다.</p>`,
      '신': `<p>신금 일간의 ${name}님은 섬세함과 전문성을 살릴 수 있는 분야가 적합합니다. 보석, 귀금속, 패션, 의료(특히 치과/피부과), 미용 분야에서 재능을 발휘합니다. 금융 분석, 감정(鑑定), 편집 등 세밀한 작업이 필요한 분야에도 적합합니다.</p>`,
      '임': `<p>임수 일간의 ${name}님은 유동적이고 넓은 분야가 적합합니다. 무역, 유통, 해운, 여행, IT, 미디어 등 세계를 무대로 활동하는 분야에서 능력을 발휘합니다. 사업 수완이 좋아 큰 사업체를 운영하는 데도 적합하며, 다양한 인맥을 활용한 비즈니스에 강합니다.</p>`,
      '계': `<p>계수 일간의 ${name}님은 지혜와 감수성을 살릴 수 있는 분야가 적합합니다. 연구, 교육, 심리상담, 작가, 종교, 점술 등 내면의 깊이가 필요한 분야에서 재능을 발휘합니다. 의약, 바이오, 수산업 분야와도 인연이 있습니다.</p>`
    };

    text += careerMap[dm] || '';

    // 십신으로 본 직업 적성
    text += `<h4>십신으로 본 직업 방향</h4>`;
    const strongest = dominant.strongest;
    const sipsinCareer = {
      '비겁': `<p>비겁이 강하여 독립적인 직업이 적합합니다. 자영업, 프리랜서, 1인 기업, 스포츠 선수 등 자기 능력으로 승부하는 분야에서 성공할 수 있습니다. 경쟁적인 환경에서 동기부여를 받으며, 동업보다는 독립 경영이 어울립니다.</p>`,
      '식상': `<p>식상이 강하여 창의적인 직업이 적합합니다. 예술가, 디자이너, 작가, 셰프, 연예인, 크리에이터 등 자기표현을 통해 가치를 만드는 분야에서 두각을 나타냅니다. 기술직이나 전문 기능직에서도 좋은 성과를 낼 수 있습니다.</p>`,
      '재성': `<p>재성이 강하여 사업가 기질이 있습니다. 장사, 무역, 유통, 부동산, 금융 등 재물을 직접 다루는 분야에서 성공할 수 있습니다. 현실 감각이 뛰어나 투자나 재테크에서도 좋은 성과를 기대할 수 있습니다.</p>`,
      '관성': `<p>관성이 강하여 조직 내에서 성공하기 좋습니다. 공무원, 대기업 임원, 관리직, 법조인, 행정가 등 안정적인 조직에서 높은 자리에 오를 수 있습니다. 규율과 질서가 있는 환경에서 능력을 발휘합니다.</p>`,
      '인성': `<p>인성이 강하여 학문과 교육 분야가 적합합니다. 교수, 교사, 연구원, 학자, 전문 자격사 등 지식을 다루는 분야에서 성공할 수 있습니다. 평생 학습자로서 지속적인 자기 발전이 직업적 성공의 열쇠입니다.</p>`
    };

    text += sipsinCareer[strongest[0]] || '';

    return text;
  }

  // =====================================================
  // 9. 건강운
  // =====================================================
  generateHealth(ctx) {
    const { dm, dmElement, name, elements, strength, season } = ctx;

    let text = `<h4>${name}님의 건강 체크 🏥</h4>`;

    // 오행별 장부 대응
    const organMap = {
      '목': { organs: '간(肝)과 담(膽)', symptoms: '눈의 피로, 근육 경련, 화가 잘 남, 소화 장애', advice: '봄나물 섭취, 눈 휴식, 스트레칭, 산림욕' },
      '화': { organs: '심장(心)과 소장(小腸)', symptoms: '가슴 두근거림, 불면증, 혀 질환, 혈액순환 장애', advice: '충분한 수면, 명상, 가벼운 유산소 운동, 쓴맛 음식' },
      '토': { organs: '비(脾)와 위(胃)', symptoms: '소화불량, 식욕부진, 근육 무력, 당뇨 주의', advice: '규칙적인 식사, 과식 자제, 단맛 과다 섭취 주의, 걷기 운동' },
      '금': { organs: '폐(肺)와 대장(大腸)', symptoms: '호흡기 질환, 피부 트러블, 알레르기, 변비', advice: '심호흡, 깨끗한 공기, 매운 음식 적당히, 피부 관리' },
      '수': { organs: '신장(腎)과 방광(膀胱)', symptoms: '요통, 부종, 생식기 관련, 뼈 관절 문제', advice: '충분한 수분 섭취, 짠 음식 줄이기, 하체 운동, 족욕' }
    };

    // 일간 오행 관련 건강
    const dmOrgan = organMap[dmElement];
    text += `<p>${name}님의 일간 ${dm}(${dmElement})과 관련된 주요 장부는 <strong>${dmOrgan.organs}</strong>이에요. 이 부분이 체질적으로 민감할 수 있으니 평소에 잘 관리해주세요!</p>`;
    text += `<p>주의할 증상: ${dmOrgan.symptoms}</p>`;
    text += `<p>건강 꿀팁: ${dmOrgan.advice}</p>`;

    // 부족한 오행 관련 건강
    const { missing, weakest } = elements;
    if (missing.length > 0) {
      text += `<h4>부족한 오행으로 본 취약 부위</h4>`;
      missing.forEach(el => {
        const info = organMap[el];
        text += `<p><strong>${el}(${info.organs})</strong>이 사주에 없어 이 부분의 건강에 특별한 주의가 필요합니다. ${info.symptoms} 등의 증상이 나타날 수 있습니다. ${info.advice}을(를) 실천하세요.</p>`;
      });
    } else {
      const weakOrgan = organMap[weakest.element];
      text += `<h4>가장 약한 오행으로 본 주의점</h4>`;
      text += `<p>가장 약한 오행인 <strong>${weakest.element}(${weakOrgan.organs})</strong>과 관련된 건강에 주의가 필요합니다. ${weakOrgan.symptoms} 등의 증상이 나타날 수 있으며, ${weakOrgan.advice}을(를) 실천하면 좋습니다.</p>`;
    }

    // 과다한 오행 관련
    const { strongest } = elements;
    if (strongest.count >= 4) {
      const strongOrgan = organMap[strongest.element];
      text += `<h4>과다한 오행으로 본 주의점</h4>`;
      text += `<p>${strongest.element} 기운이 과다합니다. ${strongOrgan.organs}이 과도하게 활성화되어 역효과가 날 수 있습니다. ${strongOrgan.symptoms}이 심해질 수 있으니 균형 잡힌 생활이 중요합니다.</p>`;
    }

    // 신강/신약별 건강 조언
    text += `<h4>체질별 건강 관리</h4>`;
    if (strength.level === 'strong') {
      text += `<p>신강한 체질이라 기본 체력은 좋은 편이에요! 하지만 너무 자신해서 건강 관리를 소홀히 하기 쉬우니 주의하세요. 에너지가 넘쳐서 과로하기 쉽고, 스트레스는 운동으로 풀어주는 게 좋아요. 웨이트, 마라톤, 격투기 같은 강도 높은 운동이 잘 맞아요 💪</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>신약한 체질이라 체력 관리에 좀 더 신경 써야 해요. 과로를 피하고 규칙적인 생활을 유지하는 게 중요해요! 걷기, 요가, 수영 같은 가벼운 운동이 잘 맞고, 영양 섭취도 챙기되 과식은 피하세요. 충분한 수면이 특히 중요해요! 환절기에 건강이 흔들릴 수 있으니 미리미리 대비하세요 🧘</p>`;
    } else {
      text += `<p>중화된 체질이라 전반적인 건강 밸런스가 좋은 편이에요! 지금 건강 상태를 유지하면서 부족한 부분을 보완해나가면 돼요. 유산소와 근력 운동을 균형 있게 하고, 다양한 음식을 골고루 먹으면 OK!</p>`;
    }

    // 계절별 건강 조언
    text += `<h4>태어난 계절별 건강 특성</h4>`;
    const seasonHealth = {
      '봄': `<p>${season}에 태어나 목(木)의 기운이 강합니다. 간과 담의 건강에 특히 주의하며, 봄철 알레르기나 피로에 유의하세요. 신선한 채소를 많이 섭취하고, 산책을 즐기면 건강 유지에 도움이 됩니다.</p>`,
      '여름': `<p>${season}에 태어나 화(火)의 기운이 강합니다. 심장과 혈관 건강에 주의하며, 여름철 열사병이나 탈수에 유의하세요. 수분 섭취를 충분히 하고, 명상이나 호흡 운동으로 심신을 안정시키세요.</p>`,
      '가을': `<p>${season}에 태어나 금(金)의 기운이 강합니다. 폐와 호흡기 건강에 주의하며, 가을철 건조함으로 인한 피부 트러블에 유의하세요. 심호흡 운동과 충분한 보습이 도움이 됩니다.</p>`,
      '겨울': `<p>${season}에 태어나 수(水)의 기운이 강합니다. 신장과 비뇨기 건강에 주의하며, 겨울철 추위로 인한 관절통에 유의하세요. 따뜻한 음식을 섭취하고 하체를 따뜻하게 유지하세요.</p>`
    };
    text += seasonHealth[season] || '';

    return text;
  }

  // =====================================================
  // 10. 올해 운세 (2026 병오년)
  // =====================================================
  generateYearFortune(ctx) {
    const { dm, dmElement, name, daewoon, sipsin, elements } = ctx;
    const yearFortune = daewoon.yearFortune;

    let text = `<h4>2026년 병오(丙午)년 운세</h4>`;
    text += `<p>2026년은 <strong>병오(丙午)년</strong>이에요! 천간 병(丙, 양화)과 지지 오(午, 양화)가 만난 해로, 화(火)의 기운이 엄청 강한 해예요. 열정과 활동성이 넘치는 한 해가 될 거예요 🔥</p>`;

    // 일간과 세운의 관계
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const yearEl = '화'; // 병오년은 화
    const yearIdx = cycle.indexOf(yearEl);

    text += `<h4>${dm} 일간과 병오년의 관계</h4>`;

    if (dmElement === '화') {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})과 올해 병오의 기운이 같은 화(火)입니다. 비겁의 해로, 자아가 강해지고 독립적인 활동이 활발해집니다. 경쟁이 치열해질 수 있지만, 자신감도 함께 올라갑니다. 동료나 형제와의 협력이 중요하며, 동업이나 공동 프로젝트에서 좋은 성과를 기대할 수 있습니다.</p>`;
    } else if ((dmIdx + 1) % 5 === yearIdx) {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})이 올해의 화 기운을 생해줍니다. 식상의 해로, 자기 표현과 창작 활동에 유리합니다. 새로운 아이디어나 프로젝트를 시작하기 좋으며, 재능이 빛을 발할 수 있습니다. 다만 에너지 소모가 크므로 건강 관리에 신경 쓰세요.</p>`;
    } else if ((dmIdx + 2) % 5 === yearIdx) {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})이 올해의 화 기운을 극합니다. 재성의 해로, 재물 운이 상승합니다. 사업 확장이나 투자에 좋은 시기이며, 수입 증가를 기대할 수 있습니다. 적극적인 경제 활동이 좋은 결과를 가져옵니다.</p>`;
    } else if ((yearIdx + 2) % 5 === dmIdx) {
      text += `<p>올해의 화 기운이 ${name}님의 일간 ${dm}(${dmElement})을 극합니다. 관성의 해로, 외부의 압력이나 변화가 있을 수 있습니다. 직장에서의 변동, 승진 시험, 공적 평가 등이 예상됩니다. 도전적인 상황이 성장의 기회가 될 수 있으니, 겸허하게 대처하세요.</p>`;
    } else {
      text += `<p>올해의 화 기운이 ${name}님의 일간 ${dm}(${dmElement})을 생해줍니다. 인성의 해로, 학업과 자기 발전에 유리합니다. 새로운 것을 배우거나 자격증을 따기 좋으며, 윗사람이나 스승의 도움을 받을 수 있습니다. 정신적으로 풍요로운 한 해가 될 것입니다.</p>`;
    }

    // 월별 운세 개요
    text += `<h4>2026년 월별 운세 개요</h4>`;
    const monthlyFortunes = [
      { month: '1~2월', desc: '새해의 시작과 함께 계획을 세우기 좋은 시기입니다. 입춘 이후 새로운 기운이 유입됩니다.' },
      { month: '3~4월', desc: '봄의 기운과 함께 활동성이 높아집니다. 새로운 프로젝트나 인간관계를 시작하기 좋습니다.' },
      { month: '5~6월', desc: '화(火)의 기운이 점점 강해지면서 열정이 최고조에 달합니다. 과로에 주의하되 적극적으로 행동하세요.' },
      { month: '7~8월', desc: '한여름 화기가 극에 달하므로 건강 관리에 특히 주의하세요. 중요한 결정은 신중하게 내리세요.' },
      { month: '9~10월', desc: '가을의 금 기운이 화를 조절해줍니다. 수확의 시기로, 상반기 노력의 결실을 거둘 수 있습니다.' },
      { month: '11~12월', desc: '수 기운이 강해지며 정리의 시기입니다. 한 해를 마무리하고 다음 해를 준비하세요.' }
    ];

    text += `<p>`;
    monthlyFortunes.forEach(mf => {
      text += `<strong>${mf.month}:</strong> ${mf.desc}<br>`;
    });
    text += `</p>`;

    // 현재 대운과의 복합 분석
    if (daewoon.currentDaewoon) {
      text += `<h4>현재 대운과 세운의 복합 분석</h4>`;
      const cd = daewoon.currentDaewoon;
      text += `<p>현재 ${cd.display} 대운(${cd.ageRange})을 지나면서 2026년 병오년을 맞이하셨습니다. 대운의 ${cd.element}/${cd.branchElement} 기운과 세운의 화/화 기운이 만나 `;

      if (cd.element === '화' || cd.branchElement === '화') {
        text += `화 기운이 더욱 강해지는 시기입니다. 열정적이고 활동적인 한 해가 되겠지만, 과열에 주의하세요. 심장과 혈관 건강을 챙기고, 감정 조절에 신경 쓰세요.</p>`;
      } else if (cd.element === '수' || cd.branchElement === '수') {
        text += `수화(水火)의 충돌이 있을 수 있습니다. 갈등이나 내적 고민이 생길 수 있지만, 이를 통해 더 성숙해질 수 있습니다. 중요한 결정 앞에서 감정보다 이성을 우선하세요.</p>`;
      } else if (cd.element === '목' || cd.branchElement === '목') {
        text += `목생화(木生火)의 흐름이 만들어집니다. 자연스러운 성장과 발전이 기대되며, 계획한 일들이 순조롭게 진행될 수 있습니다.</p>`;
      } else if (cd.element === '토' || cd.branchElement === '토') {
        text += `화생토(火生土)의 흐름이 만들어집니다. 안정적인 기반을 다지기 좋은 시기이며, 부동산이나 자산 관리에 유리합니다.</p>`;
      } else {
        text += `금 기운과 화 기운의 상호작용이 있습니다. 변화와 조정의 시기로, 유연한 대처가 필요합니다.</p>`;
      }
    }

    return text;
  }

  // =====================================================
  // 11. 종합 조언
  // =====================================================
  generateAdvice(ctx) {
    const { dm, dmElement, name, sipsin, strength, elements, daewoon, season, genderKo } = ctx;
    const dominant = sipsin.dominant;
    const { missing } = elements;

    let text = `<h4>종합 조언</h4>`;

    text += `<p>${name}님의 사주를 전체적으로 살펴봤어요! 마지막으로 ${name}님의 삶을 더 풍요롭게 만들어줄 조언을 드릴게요 😊</p>`;

    // 강점
    text += `<h4>${name}님의 타고난 강점 ✨</h4>`;
    text += `<p>`;
    const strengthAdvice = {
      '갑': '개척정신과 리더십이 뛰어나며, 정의감이 강합니다.',
      '을': '유연한 적응력과 사교성이 뛰어나며, 예술적 감각이 있습니다.',
      '병': '밝은 에너지와 카리스마가 있으며, 사람들을 이끄는 힘이 있습니다.',
      '정': '깊은 통찰력과 집중력이 있으며, 섬세한 감수성의 소유자입니다.',
      '무': '듬직한 안정감과 포용력이 있으며, 사람들의 신뢰를 얻습니다.',
      '기': '세심한 배려와 실용적 감각이 있으며, 꾸준히 노력합니다.',
      '경': '강한 결단력과 실행력이 있으며, 의리를 중시합니다.',
      '신': '세련된 감각과 분석력이 있으며, 완벽을 추구합니다.',
      '임': '넓은 포용력과 사업 수완이 있으며, 지혜롭습니다.',
      '계': '깊은 직관력과 감수성이 있으며, 순수한 마음을 가졌습니다.'
    };
    text += `${name}님은 ${dm} 일간으로 ${strengthAdvice[dm]} `;

    const strongGroup = dominant.strongest[0];
    const sipsinStrength = {
      '비겁': '독립적으로 일을 추진하는 힘이 있고, 자기만의 길을 개척해 나갈 수 있어요!',
      '식상': '창의적 재능이 풍부하고, 자기 표현으로 가치를 만들어낼 수 있어요!',
      '재성': '현실 감각이 뛰어나고, 돈을 다루는 능력이 있어요!',
      '관성': '사회적 책임감이 강하고, 조직에서 높은 자리에 오를 수 있어요!',
      '인성': '학문적 재능이 있고, 깊은 사고력으로 지혜를 쌓아가요!'
    };
    text += `십신으로 보면 ${strongGroup}이(가) 강해서 ${sipsinStrength[strongGroup]}</p>`;

    // 보완할 점
    text += `<h4>이것만 보완하면 완벽!</h4>`;
    const weakGroup = dominant.weakest[0];
    const sipsinWeak = {
      '비겁': '자기 주관과 독립심을 키워보세요! 자신의 의견을 당당히 표현하고, 스스로 결정하는 연습을 해보는 거예요.',
      '식상': '자기 표현의 통로를 만들어보세요! 취미나 창작 활동으로 내면의 감정을 건강하게 풀어보는 거예요.',
      '재성': '재물 관리에 관심을 가져보세요! 경제 공부도 하고 재테크도 시작해보면 좋아요. 현실적인 목표 세우기가 중요해요!',
      '관성': '자기 절제와 책임감을 길러보세요! 규칙적인 생활 습관을 만들면 삶이 한결 안정될 거예요.',
      '인성': '꾸준한 학습과 자기 발전에 투자해보세요! 독서, 강의, 자격증 공부 등으로 지식을 쌓으면 인생에 엄청 도움이 돼요!'
    };
    text += `<p>${sipsinWeak[weakGroup]}</p>`;

    // 부족한 오행 보완
    if (missing.length > 0) {
      text += `<h4>오행 보완 방법</h4>`;
      const elementCompensation = {
        '목': '초록색 소품이나 의류를 활용하고, 식물을 가까이 하세요. 동쪽 방향이 좋으며, 산책이나 등산을 즐기세요.',
        '화': '빨간색이나 보라색 소품을 활용하고, 밝은 조명의 환경을 만드세요. 남쪽 방향이 좋으며, 사교 활동을 늘리세요.',
        '토': '황색이나 갈색 계열을 활용하고, 안정적인 환경을 조성하세요. 중앙이 좋으며, 정원 가꾸기나 요리를 즐기세요.',
        '금': '흰색이나 금색 소품을 활용하고, 깨끗하고 정돈된 환경을 유지하세요. 서쪽 방향이 좋으며, 음악 감상이 도움이 됩니다.',
        '수': '검정이나 남색 계열을 활용하고, 물 가까운 곳을 찾으세요. 북쪽 방향이 좋으며, 수영이나 온천이 도움이 됩니다.'
      };
      missing.forEach(el => {
        text += `<p><strong>${el} 보완:</strong> ${elementCompensation[el]}</p>`;
      });
    }

    // 2026년 특별 조언
    text += `<h4>2026년을 위한 조언</h4>`;
    text += `<p>2026년 병오년은 화(火)의 기운이 매우 강한 해입니다. `;

    if (dmElement === '목') {
      text += `${dm} 일간에게는 목생화(木生火)의 흐름으로 에너지가 빠져나갈 수 있습니다. 체력 관리에 신경 쓰면서 자기 표현과 창작 활동에 힘쓰면 좋은 결과를 얻을 수 있습니다.`;
    } else if (dmElement === '화') {
      text += `${dm} 일간에게는 같은 화 기운이 합류하여 기운이 매우 강해집니다. 자신감과 활력이 넘치지만, 과열에 주의하세요. 경쟁 상황에서 유리하며 자기 사업이나 프로젝트에 좋습니다.`;
    } else if (dmElement === '토') {
      text += `${dm} 일간에게는 화생토(火生土)의 흐름으로 도움을 받는 해입니다. 학업, 자격증, 지식 분야에서 성과를 거둘 수 있으며, 윗사람의 도움이 있습니다.`;
    } else if (dmElement === '금') {
      text += `${dm} 일간에게는 화극금(火剋金)의 흐름으로 도전적인 해입니다. 직장이나 사회적 활동에서 압박이 있을 수 있지만, 이를 통해 단련되고 성장합니다.`;
    } else {
      text += `${dm} 일간에게는 재물의 기회가 오는 해입니다. 수극화(水剋火)의 흐름으로 적극적인 재물 활동이 성과를 가져옵니다. 투자나 사업에 좋은 시기입니다.`;
    }
    text += `</p>`;

    // 마무리
    text += `<h4>마무리하며 🌟</h4>`;
    text += `<p>사주는 타고난 기질과 운의 흐름을 보여주는 거지, 운명이 정해져 있다는 뜻은 아니에요! 사주를 통해 나의 강점을 알고 약점을 보완하면서, 좋은 시기엔 과감하게 나아가고 어려운 시기엔 인내하며 준비하는 게 진짜 지혜로운 삶이에요.</p>`;
    text += `<p>${name}님은 ${dm} 일간의 멋진 기운을 가지고 이 세상에 오셨어요! 자신의 장점을 살리고 부족한 부분은 천천히 채워나가면서, 주변 사람들과 좋은 인연을 만들어가세요. 사주는 참고자료일 뿐, 진짜 인생을 만들어가는 건 바로 ${name}님 자신이랍니다! 💪</p>`;
    text += `<p>항상 건강하고 행복한 날들만 가득하길 진심으로 응원해요! 다음에 또 놀러 오세요~ 🙏✨</p>`;

    return text;
  }
}
